<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=0"
    />
    <title>Mise à jour de contact</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.1/css/bootstrap.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      /* Ajouter un style pour garder le footer en bas */
      body,
      html {
        height: 100%;
        margin: 0;
        display: flex;
        flex-direction: column;
      }

      .container {
        flex: 1;
      }

      footer {
        background-color: #f8f9fa;
        text-align: center;
        padding: 20px 0;
        margin-top: auto;
        font-size: 14px;
        color: #6c757d;
      }

      footer a {
        text-decoration: none;
        color: #007bff;
      }

      footer a:hover {
        text-decoration: underline;
      }
    </style>
  </head>

  <body>
    <div class="container mt-5">
      <h3 class="text-center">Mise à jour de contact (.vcf)</h3>
      <form id="updateForm">
        <div class="mb-3">
          <label for="file" class="form-label"
            >Sélectionner le fichier (.vcf)</label
          >
          <input
            type="file"
            id="file"
            class="form-control"
            accept=".vcf"
            required
          />
        </div>
        <button type="submit" class="btn btn-success">Mise à jour</button>
      </form>
    </div>

    <!-- Footer Section -->
    <footer>
      <p>
        Proposé par
        <a href="https://wa.me/+2290162792504" target="blank"
          >Cyrille Mahougnon GAVOEDO</a
        >
        &copy; 2024
      </p>
    </footer>

    <script>
      // Normaliser un numéro de téléphone
      function normalizeNumber(number) {
        // Nettoyer le numéro en supprimant tous les caractères non numériques
        let cleanNumber = number.replace(/\D/g, "");

        // Vérification : si le numéro commence par +229, 229 ou est composé de 8 chiffres
        if (
          cleanNumber.startsWith("229") ||
          cleanNumber.startsWith("+229") ||
          cleanNumber.length === 8
        ) {
          // Si le numéro commence par +229 ou 229, on garde uniquement les 8 derniers chiffres
          if (cleanNumber.startsWith("+229")) {
            cleanNumber = cleanNumber.slice(4); // Retirer le +229
          } else if (cleanNumber.startsWith("229")) {
            cleanNumber = cleanNumber.slice(3); // Retirer le 229
          }

          // Ajouter le préfixe 01 s'il manque
          if (!cleanNumber.startsWith("01")) {
            cleanNumber = "01" + cleanNumber;
          }

          // Ajouter le préfixe international +229
          return "+229 " + cleanNumber;
        }

        // Si le numéro ne correspond pas aux critères béninois, on le retourne tel quel
        return number;
      }

      // Traiter le fichier VCF
      function processVcf(content) {
        const lines = content.split("\n");
        const output = lines.map((line) => {
          // Traiter uniquement les lignes qui contiennent un numéro de téléphone (commencent par "TEL")
          if (line.startsWith("TEL")) {
            const match = line.match(/TEL.*:(.+)/);
            if (match) {
              const originalNumber = match[1].trim();
              const normalizedNumber = normalizeNumber(originalNumber);
              return line.replace(originalNumber, normalizedNumber);
            }
          }
          return line;
        });

        return output.join("\n");
      }

      // Gérer le formulaire
      document
        .getElementById("updateForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const fileInput = document.getElementById("file");
          if (!fileInput.files.length) {
            Swal.fire(
              "Erreur",
              "Veuillez sélectionner un fichier .vcf",
              "error"
            );
            return;
          }

          const file = fileInput.files[0];
          const reader = new FileReader();

          reader.onload = function () {
            const content = reader.result;

            // Traiter le contenu du fichier
            const updatedContent = processVcf(content);

            // Créer un fichier téléchargeable
            const blob = new Blob([updatedContent], { type: "text/vcard" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "miseajour_" + file.name;
            link.click();

            Swal.fire(
              "Succès",
              "Le fichier a été mis à jour avec succès !",
              "success"
            );
          };

          reader.onerror = function () {
            Swal.fire("Erreur", "Impossible de lire le fichier.", "error");
          };

          reader.readAsText(file);
        });
    </script>
  </body>
</html>
